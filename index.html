<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุฃุฏูุงุช ุฅุฏุฎุงู ุงููุตูุต ูุงูุจุฑููุงููุงุช โ ุงููุญุณูู</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1720; --card:#0f1726; --muted:#97a0ad; --accent:#00e6ac; --danger:#ff5c5c; --glass: rgba(255,255,255,0.03);
      --transition: 180ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
      body {
  margin:0; font-family:'Playpen Sans Arabic',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; 
  background: #091018; /* <--- ุชู ุงูุชุนุฏูู ููุง ูุฎูููุฉ ุจููู ูุงุญุฏ */
  color:#e6eef6; direction:rtl; 
  -webkit-font-smoothing:antialiased; padding:18px;
}
    .app{max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start}
    header{grid-column:1/ -1; display:flex; justify-content:space-between; align-items:center; gap:12px}
    h1{margin:0; font-size:20px; color:var(--accent)}
    .subtitle{color:var(--muted); font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 6px 24px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    
    .main .section{margin-bottom:18px}
    label{display:block; font-weight:700; margin-bottom:6px}
    input[type=text], input[type=number], select{width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
    .button-row{display:flex; gap:8px; margin-top:10px}
    .btn{background:var(--accent); color:#001; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700}
    .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.04)}
    .small{font-size:13px; color:var(--muted)}

    /* Input list */
    #mafiaInputFieldsContainer{display:flex; flex-direction:column; gap:10px}
    .input-group{display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:8px; transition: all var(--transition) ease}
    .input-group.fade-out{opacity:0; transform:translateY(-6px); height:0; padding:0 8px; margin:0}
    .input-number{min-width:30px; text-align:center; color:var(--muted)}
    .input-group input{flex:1; background:transparent; color:inherit; border:none; outline:none}
    .control-btn{padding:8px 10px; border-radius:8px; border:none; cursor:pointer}
    .copy-btn{background:#2ecc71;color:#012;border-radius:8px;padding:8px 10px}
    .paste-btn{background:#3498db;color:white}
    .remove-field-btn{background:var(--danger); color:white}

    /* Right column */
    .side .section + .section{margin-top:14px}
    .links-output p{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:6px 0}
    .links-output a{color:var(--accent); text-decoration:none; max-width:72%; overflow-wrap:anywhere}
    .links-output .copy-link-btn{background:#2b7a5f; border-radius:8px; padding:6px 10px; color:white; border:none; cursor:pointer}
    .links-output .copy-link-btn:active{transform:scale(.98)}

    /* saved list */
    .saved-codes-output .saved-code-item{display:flex; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; align-items:center; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); transition: all var(--transition)}
    .saved-codes-output .saved-code-item.fade-out{opacity:0; transform:translateX(8px); height:0; padding:0; margin:0}
    .saved-codes-output .code-display{font-family:monospace; color:var(--muted); font-size:13px}

    /* custom urls list */
    .custom-url-item-wrapper{display:flex; flex-direction:column; gap:8px; margin-top:10px}
    .custom-url-item{display:flex; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; align-items:center; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); transition: all var(--transition)}
    .custom-url-item.fade-out{opacity:0; transform:translateX(8px); height:0; padding:0; margin:0}
    .custom-url-item .url-display{font-family:monospace; color:var(--muted); font-size:13px; flex-grow:1;}
    .url-order-controls{display:flex; align-items:center; gap:6px}
    .url-order-display{
        width: 24px;
        text-align: center;
        color: var(--muted);
        font-weight: 700;
        margin-left: 6px;
    }
    
    /* New styles for the toggle button and the hidden section */
    .toggle-btn{
      position:fixed;
      bottom:20px;
      right:20px; /* Changed from left to right */
      background:var(--accent);
      color:#001;
      border:none;
      border-radius:12px;
      padding:12px 16px;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      z-index: 1000;
    }
    
    #settingsContainer{
      grid-column: 1 / -1; 
      display: none;
    }
    #settingsContainer.visible {
      display: block;
    }

    footer{grid-column:1/-1; margin-top:18px; color:var(--muted); font-size:13px; text-align:center}

    /* search */
    .search-row{display:flex; gap:8px; align-items:center; margin-top:8px}
    .search-input{flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}

    /* loader */
    .loader{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);border-radius:50%;animation:spin 800ms linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* toast */
    .toast{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;z-index:2000;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}

    @media (max-width:980px){
      .app{grid-template-columns:1fr}
      .side{order:-1}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>ูููุฏ ุงูุฑูุงุจุท ุงูุฐูู โ ููุญุฉ ุงูุณูุทุฑุฉ</h1>
        <div class="subtitle">ูุณุฎุฉ ูุญุณููุฉ โ ูู ุงููุฒุงูุง ูุญููุธุฉ + ุฃุฏุงุก ููุงุฌูุฉ ุฃูุถู</div>
      </div>
      <div class="small">ุญูุธ ุชููุงุฆู ูุคูุช โข ูุฏุนู Firebase โข ุงุฎุชุตุงุฑุงุช ูููุณุฎ</div>
    </header>

    <main class="main card">
      <section class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <strong>ุฃุฏุงุฉ ุฅุฏุฎุงู ุงููุตูุต</strong>
          <div class="small">ุฃุถู ุฃูุซุฑ ูู ุฎุงูุฉ โ ุงุญูุธ ุงูุณุฌูุงุช ูู Firebase</div>
        </div>

        <div id="mafiaInputFieldsContainer"></div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="addFieldBtn"><i class="fas fa-plus-circle"></i>&nbsp; ุฅุถุงูุฉ ุฎุงูุฉ</button>
          <button class="btn ghost" id="clearAllBtn"><i class="fas fa-trash"></i>&nbsp; ูุณุญ ุงููู</button>
        </div>
      </section>

      <section class="section">
        <strong>ุงูุณุฌูุงุช (Records)</strong>
        <div style="display:flex;gap:10px;margin-top:8px;align-items:center">
          <select id="mafiaRecordSelector" style="flex:1"></select>
          <button class="btn" id="saveAsBtn"><i class="fas fa-save"></i>&nbsp; ุญูุธ ุจุงุณู</button>
          <button class="btn ghost" id="deleteRecordBtn"><i class="fas fa-trash-alt"></i>&nbsp; ุญุฐู</button>
        </div>
        <div class="small" style="margin-top:8px">ุงูุณุฌู ุงูุญุงูู ูุญููุธ ุขููุงู ูุน ุชุฃุฎูุฑ (debounced) ูุชูููู ุนูููุงุช ุงููุชุงุจุฉ ุนูู Firebase.</div>
      </section>

      <section class="section">
        <strong>ููููุฏ ุฑูุงุจุท ุงูุจุฑููุงููุงุช</strong>
        <div class="small">ุฃุฏุฎู ููุฏ ุจุฑููุงูู (Base64) ูุงุถุบุท ุชูููุฏ</div>
        <label for="profileCode">ููุฏ ุงูุจุฑููุงูู</label>
        <input type="text" id="profileCode" placeholder="ูุซุงู: NDIyNDk2MjQ5Mw==">
        <div class="button-row">
          <button class="btn" id="genProfileBtn">ุชูููุฏ ุงูุฑูุงุจุท</button>
          <button class="btn ghost" id="openAllProfileBtn">ูุชุญ ูู ุงูุฑูุงุจุท</button>
        </div>
        <div id="outputLinks" class="links-output" style="margin-top:10px">ูุง ุชูุฌุฏ ุฑูุงุจุท.</div>
      </section>

      <section class="section">
        <strong>ููููุฏ ุฑูุงุจุท ุชุณุฌูู ุงูุฏุฎูู</strong>
        <label for="loginCode">ููุฏ (ุงุฎุชูุงุฑู)</label>
        <input type="text" id="loginCode" placeholder="ุฃู ููุฏ ุฃู ุงุชุฑูู ูุงุฑุบูุง">
        <div class="button-row">
          <button class="btn" id="genLoginBtn">ุชูููุฏ ุฑูุงุจุท ุงูุฏุฎูู</button>
          <button class="btn ghost" id="openAllLoginBtn">ูุชุญ</button>
        </div>
        <div id="outputLoginLinks" class="links-output" style="margin-top:10px">ูุง ุชูุฌุฏ ุฑูุงุจุท.</div>
      </section>
      
      <section class="section">
        <strong>ุงูุณุฌู ุงูุงูุชุฑุงุถู</strong>
        <div class="small">ุงุณุชุฎุฏู ุงูุณุฌู ุงูุงูุชุฑุงุถู ููููุงู ุงูุณุฑูุนุฉ</div>
        <div style="margin-top:10px"><button class="btn ghost" id="loadDefaultBtn">ุชุญููู ุงูุชุฑุงุถู</button></div>
      </section>
    </main>

    <div class="side">
      <div class="card">
        <section class="section">
          <strong>ุฅุฏุงุฑุฉ ุฃููุงุฏ ุงูุจุฑููุงููุงุช ุงููุญููุธุฉ</strong>
          <div class="small">ุงุญูุธ ููุฏ ุจุงุณู โ ูุนุฑุถ ุงูุฃููุงุฏ ูุน ุฃุฒุฑุงุฑ ุชุญููู/ูุณุฎ/ุญุฐู</div>

          <div class="search-row">
            <input type="text" id="savedSearch" class="search-input" placeholder="ุงุจุญุซ ูู ุงูุฃููุงุฏ ุงููุญููุธุฉ...">
            <div id="savedLoader" style="display:none" class="loader" title="ุฌุงุฑู ุงูุชุญููู"></div>
          </div>

          <label for="codeName" style="margin-top:8px">ุงุณู ุงูููุฏ</label>
          <input type="text" id="codeName" placeholder="ูุซุงู: ุจุฑููุงูู ุตุฏูู">
          <div class="button-row" style="margin-top:8px">
            <button class="btn" id="saveCodeBtn">ุญูุธ ุงูููุฏ</button>
          </div>
          <div id="savedCodesOutput" class="saved-codes-output" style="margin-top:12px">ูุง ุชูุฌุฏ ุฃููุงุฏ ูุญููุธุฉ.</div>
        </section>
      </div>
    </div>

    <div id="settingsContainer" class="card">
      <section class="section">
        <strong>ุฅุฏุงุฑุฉ ุงูููุงูุน ุงููุฎุตุตุฉ</strong>
        <div class="small">ุฃุถูุ ุนุฏูู ุฃู ุงุญุฐู ุฑูุงุจุท ุงูููุงูุน ุงูุชู ุชุฑูุฏูุง. ูุชู ุญูุธ ุงูุชุนุฏููุงุช ุชููุงุฆูุงู.</div>
        
        <label for="profileUrlInput" style="margin-top:8px">ุฅุถุงูุฉ ุฑุงุจุท ุจุฑููุงูู</label>
        <div style="display:flex; gap:8px;">
          <input type="text" id="profileUrlInput" placeholder="https://example.com/profile/" style="flex:1;">
          <button class="btn" id="addProfileUrlBtn">ุฃุถู</button>
        </div>
        <div id="profileUrlList" class="custom-url-item-wrapper"></div>
        
        <label for="loginUrlInput" style="margin-top:16px">ุฅุถุงูุฉ ุฑุงุจุท ุชุณุฌูู ุฏุฎูู</label>
        <div style="display:flex; gap:8px;">
          <input type="text" id="loginUrlInput" placeholder="https://example.com/login" style="flex:1;">
          <button class="btn" id="addLoginUrlBtn">ุฃุถู</button>
        </div>
        <div id="loginUrlList" class="custom-url-item-wrapper"></div>
      </section>
    </div>

    <footer>๐ ุชู ุชุญุณูู ุงูุฃุฏุงุก: ุญูุธ ุขูู ูุคุฌูุ ุชุญุฏูุซ DOM ุจููุงุกุฉุ ููุฒุงููุฉ ูุงููุฉ ูุน Firebase.</footer>
  </div>

  <button id="toggleSettingsBtn" class="toggle-btn">
    โ๏ธ ุงูุฅุนุฏุงุฏุงุช
  </button>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // --------------------------- Firebase init ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4_IUaC1uiqq05TKpL348kXt1aNJf1jzM",
      authDomain: "mafia-3l-entag.firebaseapp.com",
      projectId: "mafia-3l-entag",
      storageBucket: "mafia-3l-entag.firebasestorage.app",
      messagingSenderId: "995219729881",
      appId: "1:995219729881:web:5d128bce8987d812adfdc8",
      measurementId: "G-Z7ZMFV8VV8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --------------------------- State & constants ---------------------------
    const state = {
      mafiaInputCounter: 0,
      currentRecordName: 'ุงูุณุฌู ุงูุงูุชุฑุงุถู',
      profileBaseUrls: [],
      loginBaseUrls: []
    };

    const MAFIA_RECORD_NAMES_KEY = 'mafiaRecordNames';
    const MAFIA_CURRENT_RECORD_KEY = 'mafiaCurrentRecord';
    const MAFIA_DEFAULT_RECORD_NAME = 'ุงูุณุฌู ุงูุงูุชุฑุงุถู';
    const PROFILE_SAVED_CODES_KEY = 'savedProfileCodesList';
    const CUSTOM_URLS_KEY = 'customUrls';

    const defaultProfileUrls = [
      "https://mixu.chat/profile/",
      "https://1v1chat.me/profile/",
      "https://livcam.me/profile/",
      "https://tinchat.me/profile/",
      "https://livuapp.com/profile/",
      "https://tumile.chat/profile/"
    ];

    const defaultLoginUrls = [
      "https://mixu.chat/login",
      "https://1v1chat.me/login",
      "https://livcam.me/login",
      "https://tinchat.me/login",
      "https://livuapp.com/login",
      "https://tumile.chat/login"
    ];

    // --------------------------- Helpers ---------------------------
    const el = (id) => document.getElementById(id);
    const showToast = (msg) => { const t = el('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1800); };
    const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; };
    const wait = (ms) => new Promise(r => setTimeout(r, ms));
    const escapeHtml = (s) => s ? String(s).replace(/[&<>"]+/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;" }[c] || c)) : '';
    const safeGetDoc = async (path) => {
      try { return await getDoc(doc(db, ...path)); } catch (e) { console.error('safeGetDoc', e); throw e; }
    };
    const safeSetDoc = async (path, data) => {
      try { await setDoc(doc(db, ...path), data); } catch (e) { console.error('safeSetDoc', e); throw e; }
    };
    const safeDeleteDoc = async (path) => {
      try { await deleteDoc(doc(db, ...path)); } catch (e) { console.error('safeDeleteDoc', e); throw e; }
    };

    // Helper for creating and styling buttons
    const createButton = (text, className, handler, title = '') => {
      const btn = document.createElement('button');
      btn.className = className;
      btn.textContent = text;
      btn.title = title;
      btn.addEventListener('click', handler);
      return btn;
    };

    // Unified copy function
    const copyToClipboard = async (text, btn) => {
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = 'โ';
        setTimeout(() => btn.textContent = 'ูุณุฎ', 900);
        showToast('โ ุชู ุงููุณุฎ');
      } catch (e) {
        showToast('โ ูุดู ุงููุณุฎ');
      }
    };

    // --------------------------- Custom URLs Management ---------------------------
    const getCustomUrls = async () => {
      try {
        const profileSnap = await safeGetDoc(["customUrls", "profile"]);
        const loginSnap = await safeGetDoc(["customUrls", "login"]);
        const profileUrls = profileSnap.exists() && profileSnap.data().urls ? profileSnap.data().urls : defaultProfileUrls;
        const loginUrls = loginSnap.exists() && loginSnap.data().urls ? loginSnap.data().urls : defaultLoginUrls;
        return { profile: profileUrls, login: loginUrls };
      } catch (e) {
        console.error('Failed to get custom URLs, using defaults.', e);
        return { profile: defaultProfileUrls, login: defaultLoginUrls };
      }
    };
    
    // Updated functions to handle reordering logic
    const saveCustomUrls = async (type, urls) => {
      try {
        await safeSetDoc(["customUrls", type], { urls: urls, lastUpdated: new Date() });
        showToast('โ ุชู ุญูุธ ุงูููุงูุน');
      } catch (e) {
        console.error('Failed to save custom URLs', e);
        showToast('โ ูุดู ุญูุธ ุงูููุงูุน');
      }
    };
    
    const reorderUrlsSimplified = (arr, fromIndex, toIndex) => {
      const movedItem = arr.splice(fromIndex, 1)[0];
      arr.splice(toIndex, 0, movedItem);
      return arr;
    };
    
    const renderCustomUrls = (urls, containerId, type) => {
      const container = el(containerId);
      container.innerHTML = '';
      
      urls.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'custom-url-item';
        
        const urlDisplay = document.createElement('div');
        urlDisplay.className = 'url-display';
        urlDisplay.textContent = url;
        
        const controls = document.createElement('div');
        controls.className = 'url-order-controls';
        
        const orderDisplay = document.createElement('div');
        orderDisplay.className = 'url-order-display';
        orderDisplay.textContent = index + 1;

        const deleteBtn = createButton('ุญุฐู', 'btn ghost', () => {
          item.classList.add('fade-out');
          setTimeout(() => {
            const newUrls = urls.filter(u => u !== url);
            state[`${type}BaseUrls`] = newUrls;
            saveCustomUrls(type, newUrls);
            renderCustomUrls(newUrls, containerId, type);
          }, 220);
        });
        deleteBtn.style.background = 'var(--danger)';
        deleteBtn.style.color = '#fff';

        const upBtn = createButton('โฒ', 'btn ghost', () => {
          if (index > 0) {
            const newUrls = reorderUrlsSimplified(urls, index, index - 1);
            state[`${type}BaseUrls`] = newUrls;
            saveCustomUrls(type, newUrls);
            renderCustomUrls(newUrls, containerId, type);
          }
        });
        
        const downBtn = createButton('โผ', 'btn ghost', () => {
          if (index < urls.length - 1) {
            const newUrls = reorderUrlsSimplified(urls, index, index + 1);
            state[`${type}BaseUrls`] = newUrls;
            saveCustomUrls(type, newUrls);
            renderCustomUrls(newUrls, containerId, type);
          }
        });

        controls.append(orderDisplay, upBtn, downBtn, deleteBtn);
        item.append(urlDisplay, controls);
        container.appendChild(item);
      });
    };

    // --------------------------- Records CRUD ---------------------------
    const saveRecord = async (recordName) => {
      const inputElements = document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]');
      const dataToSave = Array.from(inputElements).map(i => i.value);
      try {
        const isDefault = recordName === MAFIA_DEFAULT_RECORD_NAME;
        const docPath = isDefault ? ["mafiaDefaultRecord", "default"] : ["mafiaRecords", recordName];

        await safeSetDoc(docPath, { data: dataToSave, lastUpdated: new Date() });

        if (!isDefault) {
          let recordNames = await getRecordNamesFromFirebase();
          if (!recordNames.includes(recordName)) {
            recordNames.push(recordName);
            await safeSetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY], { names: recordNames });
          }
          await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: recordName });
          updateRecordSelector(recordName);
        }

        state.currentRecordName = recordName;
        localStorage.removeItem('mafia_temp_' + recordName);

        return true;
      } catch (e) {
        console.error('saveRecord', e);
        showToast('โ ูุดู ุญูุธ ุงูุณุฌู');
        return false;
      }
    };

    const loadRecord = async (recordName) => {
      const container = el('mafiaInputFieldsContainer');
      container.innerHTML = '';
      try {
        const isDefault = recordName === MAFIA_DEFAULT_RECORD_NAME;
        const docPath = isDefault ? ["mafiaDefaultRecord", "default"] : ["mafiaRecords", recordName];

        const docSnap = await safeGetDoc(docPath);
        if (docSnap.exists()) {
          const dataArray = docSnap.data().data || [];
          state.mafiaInputCounter = 0;
          for (const v of dataArray) addInputField(v, false);
        } else {
          state.mafiaInputCounter = 0;
          addInputField('', false);
        }
        updateInputNumbers();

        if (!isDefault) {
          await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: recordName });
          updateRecordSelector(recordName);
        }

        state.currentRecordName = recordName;
        localStorage.removeItem('mafia_temp_' + recordName);

        return true;
      } catch (e) {
        console.error('loadRecord', e);
        showToast('โ ูุดู ุชุญููู ุงูุณุฌู โ ุณูุชู ุงุณุชุนุงุฏุฉ ุงููุงุด ุฅู ููุฌุฏ');
        // Fallback to local cache
        try {
          const tmp = localStorage.getItem('mafia_temp_' + recordName);
          if (tmp) {
            const arr = JSON.parse(tmp);
            if (Array.isArray(arr) && arr.length > 0) {
              container.innerHTML = '';
              state.mafiaInputCounter = 0;
              arr.forEach(v => addInputField(v, false));
              updateInputNumbers();
              showToast('โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู ุงููุงุด ุงููุญูู');
            }
          }
        } catch (er) {
          console.error('restore cache', er);
        }
        return false;
      }
    };

    const getRecordNamesFromFirebase = async () => {
      try {
        const docSnap = await safeGetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY]);
        let namesArray = docSnap.exists() && docSnap.data().names ? docSnap.data().names : [];
        if (!namesArray.includes(MAFIA_DEFAULT_RECORD_NAME)) namesArray.unshift(MAFIA_DEFAULT_RECORD_NAME);
        else { namesArray = namesArray.filter(n => n !== MAFIA_DEFAULT_RECORD_NAME); namesArray.unshift(MAFIA_DEFAULT_RECORD_NAME); }
        return namesArray;
      } catch (e) { console.error('getRecordNames', e); return [MAFIA_DEFAULT_RECORD_NAME]; }
    };

    const updateRecordSelector = async (selectedName = '') => {
      const selector = el('mafiaRecordSelector');
      selector.innerHTML = '';
      const recordNames = await getRecordNamesFromFirebase();
      for (const name of recordNames) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === selectedName) opt.selected = true;
        selector.appendChild(opt);
      }
      const deleteBtn = el('deleteRecordBtn');
      if (deleteBtn) deleteBtn.disabled = (recordNames.length === 1 && recordNames[0] === MAFIA_DEFAULT_RECORD_NAME);
    };

    const saveRecordAsNew = async () => {
      let recordName = prompt('ุงุฏุฎู ุงุณู ููุณุฌู ุงูุฌุฏูุฏ:');
      if (recordName && recordName.trim() !== '') {
        recordName = recordName.trim();
        const recordNames = await getRecordNamesFromFirebase();
        if (recordNames.includes(recordName)) { if (!confirm(`ุงูุณุฌู "${recordName}" ููุฌูุฏุ ุงุณุชุจุฏุงููุ`)) return; }
        const ok = await saveRecord(recordName);
        if (ok) {
          await safeSetDoc(["mafiaRecords", MAFIA_DEFAULT_RECORD_NAME], { data: [], lastUpdated: new Date() });
          await loadRecord(recordName);
          showToast('โ ุชู ุงูุญูุธ');
        }
      } else if (recordName !== null) showToast('โ ูุฌุจ ุงุฏุฎุงู ุงุณู');
    };

    const loadSelectedRecord = async () => {
      const sel = el('mafiaRecordSelector');
      if (sel.value) await loadRecord(sel.value);
    };

    const deleteSelectedRecord = async () => {
      const sel = el('mafiaRecordSelector');
      const recordToDelete = sel.value;
      if (recordToDelete === MAFIA_DEFAULT_RECORD_NAME) {
        showToast('โ ูุง ููููู ุญุฐู ุงูุณุฌู ุงูุงูุชุฑุงุถู');
        return;
      }
      if (!confirm('ุชุฃููุฏ ุญุฐู ' + recordToDelete + 'ุ')) return;
      try {
        await safeDeleteDoc(["mafiaRecords", recordToDelete]);
        let names = await getRecordNamesFromFirebase();
        names = names.filter(n => n !== recordToDelete);
        await safeSetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY], { names });
        const currentDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const current = currentDoc.exists() ? currentDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        if (current === recordToDelete) await loadRecord(MAFIA_DEFAULT_RECORD_NAME);
        await updateRecordSelector(current === recordToDelete ? MAFIA_DEFAULT_RECORD_NAME : current);
        localStorage.removeItem('mafia_temp');
        localStorage.removeItem('mafia_temp_' + recordToDelete);
        showToast('โ ุชู ุงูุญุฐู');
      } catch (e) {
        console.error('delete', e);
        showToast('โ ุฎุทุฃ ูู ุงูุญุฐู');
      }
    };

    // --------------------------- Input fields UI ---------------------------
    const createInputGroupElement = (index, initialValue) => {
      const div = document.createElement('div');
      div.className = 'input-group';

      const removeBtn = createButton('ุญุฐู', 'remove-field-btn control-btn', () => {
        div.classList.add('fade-out');
        setTimeout(() => {
          div.remove();
          updateInputNumbers();
          debouncedSave();
        }, 220);
      }, 'ุญุฐู ุงูุฎุงูุฉ');

      const numberDiv = document.createElement('div');
      numberDiv.className = 'input-number';
      numberDiv.textContent = index + '.';

      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'mafiaTextInput' + index;
      input.value = initialValue || '';
      input.placeholder = 'ุฃุฏุฎู ุงููุต...';
      input.addEventListener('input', debouncedSave);

      const copyBtn = createButton('ูุณุฎ', 'copy-btn control-btn', () => copyToClipboard(input.value, copyBtn), 'ูุณุฎ');
      const pasteBtn = createButton('ูุตู', 'paste-btn control-btn', async () => {
        try {
          const t = await navigator.clipboard.readText();
          input.value = t;
          debouncedSave();
          showToast('โ ุชู ุงููุตู');
        } catch (e) {
          showToast('โ ูุดู ุงููุตู');
        }
      }, 'ูุตู');

      div.append(removeBtn, numberDiv, input, copyBtn, pasteBtn);
      return div;
    };

    const addInputField = (initialValue = '', saveAfterAdd = true) => {
      state.mafiaInputCounter++;
      const container = el('mafiaInputFieldsContainer');
      const div = createInputGroupElement(state.mafiaInputCounter, initialValue);
      container.appendChild(div);
      if (saveAfterAdd) debouncedSave();
    };

    const updateInputNumbers = () => {
      const groups = document.querySelectorAll('#mafiaInputFieldsContainer .input-group');
      groups.forEach((g, i) => {
        const n = g.querySelector('.input-number');
        if (n) n.textContent = (i + 1) + '.';
      });
      state.mafiaInputCounter = groups.length;
    };

    const clearCurrentDataAndStartNew = async () => {
      if (!confirm('ูุณุญ ูู ูุญุชูู ุงูุณุฌู ุงูุญุงููุ')) return;
      el('mafiaInputFieldsContainer').querySelectorAll('.input-group').forEach(g => g.classList.add('fade-out'));
      await wait(180);
      el('mafiaInputFieldsContainer').innerHTML = '';
      state.mafiaInputCounter = 0;
      addInputField('', false);
      try {
        await safeSetDoc(["mafiaRecords", MAFIA_DEFAULT_RECORD_NAME], { data: [], lastUpdated: new Date() });
        await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: MAFIA_DEFAULT_RECORD_NAME });
        localStorage.removeItem('mafia_temp');
        localStorage.removeItem('mafia_temp_' + MAFIA_DEFAULT_RECORD_NAME);
        await updateRecordSelector(MAFIA_DEFAULT_RECORD_NAME);
        showToast('โ ุชู ุงููุณุญ');
      } catch (e) {
        console.error(e);
        showToast('โ ุญุฏุซ ุฎุทุฃ');
      }
    };

    // --------------------------- Saving (debounced) ---------------------------
    const debouncedSave = debounce(async () => {
      try {
        const inputs = document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]');
        const arr = Array.from(inputs).map(i => i.value);
        const key = 'mafia_temp_' + state.currentRecordName;
        localStorage.setItem(key, JSON.stringify(arr));
        const saveTo = state.currentRecordName;
        await safeSetDoc(["mafiaRecords", saveTo], { data: arr, lastUpdated: new Date() });
      } catch (e) {
        console.error('debouncedSave', e);
      }
    }, 900);

    // --------------------------- Links generation (utils) ---------------------------
    const createLinkRow = (fullUrl, showDelete = false) => {
      const p = document.createElement('p');
      p.style.display = 'flex';
      p.style.gap = '8px';
      p.style.alignItems = 'center';

      const a = document.createElement('a');
      a.href = fullUrl;
      a.target = '_blank';
      a.textContent = fullUrl;
      
      const copyBtn = createButton('ูุณุฎ', 'copy-link-btn', () => copyToClipboard(fullUrl, copyBtn));
      
      p.append(a, copyBtn);
      
      if (showDelete) {
        const delBtn = createButton('ุญุฐู', 'copy-link-btn', () => deleteGeneratedProfileCode(fullUrl));
        delBtn.style.background = 'var(--danger)';
        delBtn.style.marginLeft = '6px';
        p.appendChild(delBtn);
      }

      return p;
    };

    const deleteGeneratedProfileCode = async (fullUrl) => {
      try {
        const last = localStorage.getItem('lastCode');
        if (last && fullUrl.endsWith(last)) localStorage.removeItem('lastCode');
        const code = state.profileBaseUrls.reduce((acc, base) => fullUrl.startsWith(base) ? fullUrl.slice(base.length) : acc, null);
        if (code) {
          const saved = await getSavedCodes();
          const filtered = saved.filter(s => s.code !== code);
          if (filtered.length !== saved.length) {
            await saveCodes(filtered);
            await renderSavedCodes();
          }
        }
        generateProfileLinks();
        showToast('โ ุชู ุงูุญุฐู ูู ุงูุชุฎุฒูู ุงููุญูู (ุฅู ูุฌุฏ)');
      } catch (e) {
        console.error(e);
        showToast('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญุฐู');
      }
    };

    const generateProfileLinks = () => {
      const code = el('profileCode').value.trim();
      const out = el('outputLinks');
      out.innerHTML = '';
      if (!code) {
        out.innerHTML = '<p class="small">โ ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุฏ ุงูุจุฑููุงูู.</p>';
        return;
      }
      const frag = document.createDocumentFragment();
      state.profileBaseUrls.forEach(base => {
        const full = base + code;
        frag.appendChild(createLinkRow(full, true));
      });
      out.appendChild(frag);
      localStorage.setItem('lastCode', code);
    };

    const openAllProfileLinks = () => {
      const links = el('outputLinks').querySelectorAll('a');
      if (links.length === 0) { showToast('ูุง ุชูุฌุฏ ุฑูุงุจุท'); return; }
      if (!confirm('ูุชุญ ' + links.length + ' ุฑุงุจุทุ')) return;
      links.forEach(a => window.open(a.href, '_blank'));
    };

    const generateLoginLinks = () => {
      const code = el('loginCode').value.trim();
      const out = el('outputLoginLinks');
      out.innerHTML = '';
      const frag = document.createDocumentFragment();
      state.loginBaseUrls.forEach(base => {
        const full = base + (code ? '/' + code : '');
        frag.appendChild(createLinkRow(full));
      });
      out.appendChild(frag);
    };

    const openAllLoginLinks = () => {
      const links = el('outputLoginLinks').querySelectorAll('a');
      if (links.length === 0) { showToast('ูุง ุชูุฌุฏ ุฑูุงุจุท'); return; }
      if (!confirm('ูุชุญ ' + links.length + ' ุฑุงุจุทุ')) return;
      links.forEach(a => window.open(a.href, '_blank'));
    };

    // --------------------------- Saved profile codes (Firestore) ---------------------------
    const getSavedCodes = async () => {
      try {
        const docSnap = await safeGetDoc(["profileData", PROFILE_SAVED_CODES_KEY]);
        return docSnap.exists() && docSnap.data().codes ? docSnap.data().codes : [];
      } catch (e) {
        console.error('getSaved', e);
        return [];
      }
    };

    const saveCodes = async (codesArray) => {
      try {
        await safeSetDoc(["profileData", PROFILE_SAVED_CODES_KEY], { codes: codesArray });
        return true;
      } catch (e) {
        console.error('saveCodes', e);
        showToast('โ ูุดู ุงูุญูุธ');
        return false;
      }
    };

    const saveProfileCode = async () => {
      const profileCode = el('profileCode').value.trim();
      const codeName = el('codeName').value.trim();
      if (!profileCode) { showToast('โ ุงุฏุฎู ููุฏ'); return; }
      if (!codeName) { showToast('โ ุงุฏุฎู ุงุณู'); return; }
      let saved = await getSavedCodes();
      if (saved.some(s => s.name === codeName)) { showToast('โ ุงูุงุณู ูุณุชุฎุฏู'); return; }
      if (saved.some(s => s.code === profileCode)) { showToast('โ ุงูููุฏ ููุฌูุฏ'); return; }
      saved.push({ name: codeName, code: profileCode });
      if (await saveCodes(saved)) {
        await renderSavedCodes();
        el('codeName').value = '';
        el('profileCode').value = '';
        showToast('โ ุชู ุงูุญูุธ');
      }
    };

    const deleteProfileCode = async (codeName) => {
      if (!confirm('ุญุฐู ' + codeName + 'ุ')) return;
      let saved = await getSavedCodes();
      saved = saved.filter(s => s.name !== codeName);
      if (await saveCodes(saved)) {
        await renderSavedCodes();
        showToast('โ ุชู ุงูุญุฐู');
      }
    };

    const loadProfileCode = (code) => {
      el('profileCode').value = code;
      showToast('โ ุชู ุชุญููู ุงูููุฏ');
    };

    /**
     * New function to handle editing a saved profile code.
     */
    const editProfileCode = async (oldCodeName, oldCode) => {
        let saved = await getSavedCodes();
        const newCodeName = prompt(`ุชุนุฏูู ุงุณู ุงูููุฏ "${oldCodeName}" ุฅูู:`, oldCodeName);
        if (newCodeName === null) return; // User cancelled
        const newCodeValue = prompt(`ุชุนุฏูู ูููุฉ ุงูููุฏ "${oldCode}" ุฅูู:`, oldCode);
        if (newCodeValue === null) return; // User cancelled
        
        const newNameTrimmed = newCodeName.trim();
        const newCodeTrimmed = newCodeValue.trim();

        if (newNameTrimmed === '' || newCodeTrimmed === '') {
            showToast('โ ูุฌุจ ุฅุฏุฎุงู ุงุณู ููููุฉ ุบูุฑ ูุงุฑุบูู');
            return;
        }

        // Check if the new name is already in use by another code
        const isNameUsed = saved.some(s => s.name === newNameTrimmed && s.name !== oldCodeName);
        if (isNameUsed) {
            showToast('โ ุงูุงุณู ุงูุฌุฏูุฏ ูุณุชุฎุฏู ุจุงููุนู');
            return;
        }

        // Find and update the code
        const updatedSaved = saved.map(item => {
            if (item.name === oldCodeName) {
                return { name: newNameTrimmed, code: newCodeTrimmed };
            }
            return item;
        });

        if (await saveCodes(updatedSaved)) {
            await renderSavedCodes();
            showToast('โ ุชู ุชุญุฏูุซ ุงูููุฏ');
        }
    };

    const renderSavedCodes = async (filter = '') => {
      const saved = await getSavedCodes();
      const out = el('savedCodesOutput');
      el('savedLoader').style.display = 'none';
      const list = saved.filter(s => !filter || s.name.includes(filter) || s.code.includes(filter));
      
      out.innerHTML = ''; // Clear previous content

      if (list.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'ูุง ุชูุฌุฏ ุฃููุงุฏ ูุญููุธุฉ.';
        out.appendChild(p);
        return;
      }

      const frag = document.createDocumentFragment();
      for (const item of list) {
        const wrap = document.createElement('div');
        wrap.className = 'saved-code-item';

        const left = document.createElement('div');
        const nameStrong = document.createElement('strong');
        nameStrong.textContent = escapeHtml(item.name);
        const codeDiv = document.createElement('div');
        codeDiv.className = 'code-display';
        codeDiv.textContent = escapeHtml(item.code);
        left.append(nameStrong, codeDiv);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '6px';
        
        const loadBtn = createButton('ุชุญููู', 'btn ghost', () => loadProfileCode(item.code));
        const copyBtn = createButton('ูุณุฎ', 'btn', () => copyToClipboard(item.code, copyBtn));
        const editBtn = createButton('ุชุนุฏูู', 'btn ghost', () => editProfileCode(item.name, item.code));
        const delBtn = createButton('ูุณุญ', 'btn ghost', async () => {
          wrap.classList.add('fade-out');
          await wait(220);
          deleteProfileCode(item.name);
        });
        
        right.append(loadBtn, copyBtn, editBtn, delBtn);
        wrap.append(left, right);
        frag.appendChild(wrap);
      }
      out.appendChild(frag);
    };

    // --------------------------- Init on load ---------------------------
    document.addEventListener('DOMContentLoaded', async () => {
      // Load custom URLs first
      const urls = await getCustomUrls();
      state.profileBaseUrls = urls.profile;
      state.loginBaseUrls = urls.login;
      renderCustomUrls(state.profileBaseUrls, 'profileUrlList', 'profile');
      renderCustomUrls(state.loginBaseUrls, 'loginUrlList', 'login');

      // Wire UI buttons
      el('addFieldBtn').addEventListener('click', () => addInputField('', true));
      el('clearAllBtn').addEventListener('click', clearCurrentDataAndStartNew);
      el('saveAsBtn').addEventListener('click', saveRecordAsNew);
      el('deleteRecordBtn').addEventListener('click', deleteSelectedRecord);
      el('genProfileBtn').addEventListener('click', generateProfileLinks);
      el('openAllProfileBtn').addEventListener('click', openAllProfileLinks);
      el('genLoginBtn').addEventListener('click', generateLoginLinks);
      el('openAllLoginBtn').addEventListener('click', openAllLoginLinks);
      el('saveCodeBtn').addEventListener('click', saveProfileCode);
      el('loadDefaultBtn').addEventListener('click', () => loadRecord(MAFIA_DEFAULT_RECORD_NAME));
      el('mafiaRecordSelector').addEventListener('change', loadSelectedRecord);
      el('savedSearch').addEventListener('input', debounce((e) => renderSavedCodes(e.target.value.trim()), 250));
      
      el('addProfileUrlBtn').addEventListener('click', () => {
        const url = el('profileUrlInput').value.trim();
        if (url && !state.profileBaseUrls.includes(url)) {
          state.profileBaseUrls.push(url);
          el('profileUrlInput').value = '';
          saveCustomUrls('profile', state.profileBaseUrls);
          renderCustomUrls(state.profileBaseUrls, 'profileUrlList', 'profile');
        } else if (url) {
          showToast('โ ุงูุฑุงุจุท ููุฌูุฏ ุจุงููุนู');
        } else {
          showToast('โ ุฃุฏุฎู ุฑุงุจุท ุตุงูุญ');
        }
      });
      el('addLoginUrlBtn').addEventListener('click', () => {
        const url = el('loginUrlInput').value.trim();
        if (url && !state.loginBaseUrls.includes(url)) {
          state.loginBaseUrls.push(url);
          el('loginUrlInput').value = '';
          saveCustomUrls('login', state.loginBaseUrls);
          renderCustomUrls(state.loginBaseUrls, 'loginUrlList', 'login');
        } else if (url) {
          showToast('โ ุงูุฑุงุจุท ููุฌูุฏ ุจุงููุนู');
        } else {
          showToast('โ ุฃุฏุฎู ุฑุงุจุท ุตุงูุญ');
        }
      });
      el('toggleSettingsBtn').addEventListener('click', () => {
        const settingsContainer = el('settingsContainer');
        settingsContainer.classList.toggle('visible');
      });


      // Initial load of records
      await updateRecordSelector();
      try {
        const currentRecordDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const currentRecordName = currentRecordDoc.exists() ? currentRecordDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        state.currentRecordName = currentRecordName;
        await loadRecord(currentRecordName);
      } catch (e) {
        // Fallback to local temp if Firestore unreachable
        const tmp = localStorage.getItem('mafia_temp');
        if (tmp) {
          try {
            const arr = JSON.parse(tmp);
            if (Array.isArray(arr) && arr.length > 0) {
              document.getElementById('mafiaInputFieldsContainer').innerHTML = '';
              state.mafiaInputCounter = 0;
              arr.forEach(v => addInputField(v, false));
              updateInputNumbers();
              showToast('โ ุชุนููุช ูู ุงููุงุด');
            }
          } catch (err) {}
        }
      }

      // Ensure at least one field
      if (document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]').length === 0) {
        addInputField('', false);
      }

      // Render saved codes
      el('savedLoader').style.display = 'inline-block';
      await renderSavedCodes();
    });
  </script>
</body>
</html>


