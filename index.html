<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>أدوات إدخال النصوص والبروفايلات — المحسّن</title>

  <!-- fonts & icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1720; --card:#0f1726; --muted:#97a0ad; --accent:#00e6ac; --danger:#ff5c5c; --glass: rgba(255,255,255,0.03);
      --transition: 180ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Playpen Sans Arabic',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; 
      background:linear-gradient(180deg,#091018 0%, #071021 100%); color:#e6eef6; direction:rtl; 
      -webkit-font-smoothing:antialiased; padding:18px;
    }
    .app{max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start}
    header{grid-column:1/ -1; display:flex; justify-content:space-between; align-items:center; gap:12px}
    h1{margin:0; font-size:20px; color:var(--accent)}
    .subtitle{color:var(--muted); font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 6px 24px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}

    /* Left column (main tools) */
    .main .section{margin-bottom:18px}
    label{display:block; font-weight:700; margin-bottom:6px}
    input[type=text], select{width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
    .button-row{display:flex; gap:8px; margin-top:10px}
    .btn{background:var(--accent); color:#001; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700}
    .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.04)}
    .small{font-size:13px; color:var(--muted)}

    /* Input list */
    #mafiaInputFieldsContainer{display:flex; flex-direction:column; gap:10px}
    .input-group{display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:8px; transition: all var(--transition) ease}
    .input-group.fade-out{opacity:0; transform:translateY(-6px); height:0; padding:0 8px; margin:0}
    .input-number{min-width:30px; text-align:center; color:var(--muted)}
    .input-group input{flex:1; background:transparent; color:inherit; border:none; outline:none}
    .control-btn{padding:8px 10px; border-radius:8px; border:none; cursor:pointer}
    .copy-btn{background:#2ecc71;color:#012;border-radius:8px;padding:8px 10px}
    .paste-btn{background:#3498db;color:white}
    .remove-field-btn{background:var(--danger); color:white}

    /* Right column */
    .side .section + .section{margin-top:14px}
    .links-output p{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:6px 0}
    .links-output a{color:var(--accent); text-decoration:none; max-width:72%; overflow-wrap:anywhere}
    .links-output .copy-link-btn{background:#2b7a5f; border-radius:8px; padding:6px 10px; color:white; border:none; cursor:pointer}
    .links-output .copy-link-btn:active{transform:scale(.98)}

    /* saved list */
    .saved-codes-output .saved-code-item{display:flex; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; align-items:center; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); transition: all var(--transition)}
    .saved-codes-output .saved-code-item.fade-out{opacity:0; transform:translateX(8px); height:0; padding:0; margin:0}
    .saved-codes-output .code-display{font-family:monospace; color:var(--muted); font-size:13px}

    footer{grid-column:1/-1; margin-top:18px; color:var(--muted); font-size:13px; text-align:center}

    /* search */
    .search-row{display:flex; gap:8px; align-items:center; margin-top:8px}
    .search-input{flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}

    /* loader */
    .loader{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);border-radius:50%;animation:spin 800ms linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* toast */
    .toast{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;z-index:2000;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}

    @media (max-width:980px){.app{grid-template-columns:1fr} .side{order:-1}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>مولد الروابط الذكي — لوحة السيطرة</h1>
        <div class="subtitle">نسخة محسّنة — كل المزايا محفوظة + أداء وواجهة أفضل</div>
      </div>
      <div class="small">حفظ تلقائي مؤقت • يدعم Firebase • اختصارات للنسخ</div>
    </header>

    <main class="main card">
      <section class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <strong>أداة إدخال النصوص</strong>
          <div class="small">أضف أكثر من خانة — احفظ السجلات في Firebase</div>
        </div>

        <div id="mafiaInputFieldsContainer"></div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="addFieldBtn"><i class="fas fa-plus-circle"></i>&nbsp; إضافة خانة</button>
          <button class="btn ghost" id="clearAllBtn"><i class="fas fa-trash"></i>&nbsp; مسح الكل</button>
        </div>
      </section>

      <section class="section">
        <strong>السجلات (Records)</strong>
        <div style="display:flex;gap:10px;margin-top:8px;align-items:center">
          <select id="mafiaRecordSelector" style="flex:1"></select>
          <button class="btn" id="saveAsBtn"><i class="fas fa-save"></i>&nbsp; حفظ باسم</button>
          <button class="btn ghost" id="deleteRecordBtn"><i class="fas fa-trash-alt"></i>&nbsp; حذف</button>
        </div>
        <div class="small" style="margin-top:8px">السجل الحالي محفوظ آلياً مع تأخير (debounced) لتقليل عمليات الكتابة على Firebase.</div>
      </section>

      <section class="section">
        <strong>مولّد روابط البروفايلات</strong>
        <div class="small">أدخل كود بروفايل (Base64) واضغط توليد</div>
        <label for="profileCode">كود البروفايل</label>
        <input type="text" id="profileCode" placeholder="مثال: NDIyNDk2MjQ5Mw==">
        <div class="button-row">
          <button class="btn" id="genProfileBtn">توليد الروابط</button>
          <button class="btn ghost" id="openAllProfileBtn">فتح كل الروابط</button>
        </div>
        <div id="outputLinks" class="links-output" style="margin-top:10px">لا توجد روابط.</div>
      </section>

      <section class="section">
        <strong>مولّد روابط تسجيل الدخول</strong>
        <label for="loginCode">كود (اختياري)</label>
        <input type="text" id="loginCode" placeholder="أي كود أو اتركه فارغًا">
        <div class="button-row">
          <button class="btn" id="genLoginBtn">توليد روابط الدخول</button>
          <button class="btn ghost" id="openAllLoginBtn">فتح</button>
        </div>
        <div id="outputLoginLinks" class="links-output" style="margin-top:10px">لا توجد روابط.</div>
      </section>
    </main>

    <aside class="side card">
      <section class="section">
        <strong>إدارة أكواد البروفايلات المحفوظة</strong>
        <div class="small">احفظ كود باسم — يعرض الأكواد مع أزرار تحميل/نسخ/حذف</div>

        <div class="search-row">
          <input type="text" id="savedSearch" class="search-input" placeholder="ابحث في الأكواد المحفوظة...">
          <div id="savedLoader" style="display:none" class="loader" title="جاري التحميل"></div>
        </div>

        <label for="codeName" style="margin-top:8px">اسم الكود</label>
        <input type="text" id="codeName" placeholder="مثال: بروفايل صديق">
        <div class="button-row" style="margin-top:8px">
          <button class="btn" id="saveCodeBtn">حفظ الكود</button>
        </div>
        <div id="savedCodesOutput" class="saved-codes-output" style="margin-top:12px">لا توجد أكواد محفوظة.</div>
      </section>

      <section class="section" style="margin-top:14px">
        <strong>السجل الافتراضي</strong>
        <div class="small">استخدم السجل الافتراضي للمهام السريعة</div>
        <div style="margin-top:10px"><button class="btn ghost" id="loadDefaultBtn">تحميل افتراضي</button></div>
      </section>
    </aside>

    <footer>🌟 تم تحسين الأداء: حفظ آلي مؤجل، تحديث DOM بكفاءة، ومزامنة كاملة مع Firebase.</footer>
  </div>

  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // --------------------------- Firebase init ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4_IUaC1uiqq05TKpL348kXt1aNJf1jzM",
      authDomain: "mafia-3l-entag.firebaseapp.com",
      projectId: "mafia-3l-entag",
      storageBucket: "mafia-3l-entag.firebasestorage.app",
      messagingSenderId: "995219729881",
      appId: "1:995219729881:web:5d128bce8987d812adfdc8",
      measurementId: "G-Z7ZMFV8VV8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --------------------------- State & constants ---------------------------
    let mafia_inputCounter = 0;
    const MAFIA_RECORD_NAMES_KEY = 'mafiaRecordNames';
    const MAFIA_CURRENT_RECORD_KEY = 'mafiaCurrentRecord';
    const MAFIA_DEFAULT_RECORD_NAME = 'السجل الافتراضي';

    const profile_baseUrls = [
      "https://mixu.chat/profile/",
      "https://1v1chat.me/profile/",
      "https://livcam.me/profile/",
      "https://tinchat.me/profile/",
      "https://livuapp.com/profile/"
    ];

    const login_baseUrls = [
      "https://mixu.chat/login",
      "https://1v1chat.me/login",
      "https://livcam.me/login",
      "https://tinchat.me/login",
      "https://livuapp.com/login"
    ];

    const PROFILE_SAVED_CODES_KEY = 'savedProfileCodesList';

    // --------------------------- Helpers ---------------------------
    function el(id){ return document.getElementById(id); }
    function showToast(msg){ const t = el('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1800); }
    function debounce(func, wait){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>func(...a), wait); }; }
    function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]||c)); }

    // --------------------------- Firebase wrappers (safer calls + loader) ---------------------------
    async function safeGetDoc(path){ // path: ["collection","id"]
      try{ return await getDoc(doc(db, path[0], path[1])); }catch(e){ console.error('safeGetDoc', e); throw e; }
    }
    async function safeSetDoc(path, data){ try{ await setDoc(doc(db, path[0], path[1]), data); }catch(e){ console.error('safeSetDoc', e); throw e; } }
    async function safeDeleteDoc(path){ try{ await deleteDoc(doc(db, path[0], path[1])); }catch(e){ console.error('safeDeleteDoc', e); throw e; } }

    // --------------------------- Records CRUD ---------------------------
    async function mafia_saveRecord(recordName){
      const inputElements = document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]');
      const dataToSave = Array.from(inputElements).map(i=>i.value);
      try{
        await safeSetDoc(["mafiaRecords", recordName], { data: dataToSave, lastUpdated: new Date() });
        // update metadata names list
        let recordNames = await mafia_getRecordNamesFromFirebase();
        if(!recordNames.includes(recordName)){
          recordNames.push(recordName);
          await safeSetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY], { names: recordNames });
        }
        await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: recordName });
        await mafia_updateRecordSelector(recordName);
        return true;
      }catch(e){ console.error('saveRecord', e); showToast('❌ فشل حفظ السجل'); return false; }
    }

    async function mafia_loadRecord(recordName){
      const container = el('mafiaInputFieldsContainer'); container.innerHTML='';
      try{
        const docSnap = await safeGetDoc(["mafiaRecords", recordName]);
        if(docSnap.exists()){
          const dataArray = docSnap.data().data || [];
          mafia_inputCounter = 0;
          for(const v of dataArray) mafia_addInputField(v, false);
        }else{ mafia_inputCounter = 0; mafia_addInputField('', false); }
        mafia_updateInputNumbers();
        await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: recordName });
        mafia_updateRecordSelector(recordName);
        // clear local cache for current record to avoid stale reappear
        localStorage.removeItem('mafia_temp');
        return true;
      }catch(e){ console.error('loadRecord', e); mafia_inputCounter = 0; mafia_addInputField('', false); showToast('❌ فشل تحميل السجل'); return false; }
    }

    async function mafia_getRecordNamesFromFirebase(){
      try{
        const docSnap = await safeGetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY]);
        let namesArray = docSnap.exists() && docSnap.data().names ? docSnap.data().names : [];
        if(!namesArray.includes(MAFIA_DEFAULT_RECORD_NAME)) namesArray.unshift(MAFIA_DEFAULT_RECORD_NAME);
        else{ namesArray = namesArray.filter(n=>n!==MAFIA_DEFAULT_RECORD_NAME); namesArray.unshift(MAFIA_DEFAULT_RECORD_NAME); }
        return namesArray;
      }catch(e){ console.error('getRecordNames', e); return [MAFIA_DEFAULT_RECORD_NAME]; }
    }

    async function mafia_updateRecordSelector(selectedName=''){
      const selector = el('mafiaRecordSelector'); selector.innerHTML = '';
      const recordNames = await mafia_getRecordNamesFromFirebase();
      for(const name of recordNames){ const opt = document.createElement('option'); opt.value=name; opt.textContent=name; if(name===selectedName) opt.selected=true; selector.appendChild(opt); }
      // enable/disable delete button based on presence
      const deleteBtn = el('deleteRecordBtn'); if(deleteBtn) deleteBtn.disabled = (recordNames.length===1 && recordNames[0]===MAFIA_DEFAULT_RECORD_NAME);
    }

    async function mafia_saveRecordAsNew(){
      let recordName = prompt('ادخل اسم للسجل الجديد:');
      if(recordName && recordName.trim()!==''){
        recordName=recordName.trim();
        const recordNames = await mafia_getRecordNamesFromFirebase();
        if(recordNames.includes(recordName)){ if(!confirm(`السجل "${recordName}" موجود، استبداله؟`)) return; }
        const ok = await mafia_saveRecord(recordName);
        if(ok){ await safeSetDoc(["mafiaRecords", MAFIA_DEFAULT_RECORD_NAME], { data: [], lastUpdated: new Date() }); await mafia_loadRecord(recordName); showToast('✅ تم الحفظ'); }
      }else if(recordName!==null) showToast('⚠ يجب ادخال اسم');
    }

    async function mafia_loadSelectedRecord(){ const sel = el('mafiaRecordSelector'); if(sel.value) await mafia_loadRecord(sel.value); }

    async function mafia_deleteSelectedRecord(){
      const sel = el('mafiaRecordSelector'); const recordToDelete = sel.value; if(recordToDelete===MAFIA_DEFAULT_RECORD_NAME){ showToast('⚠ لا يمكنك حذف السجل الافتراضي'); return; }
      if(!confirm('تأكيد حذف '+recordToDelete+'؟')) return;
      try{
        // Delete doc from Firestore
        await safeDeleteDoc(["mafiaRecords", recordToDelete]);

        // Update metadata list (remove the name)
        let names = await mafia_getRecordNamesFromFirebase();
        names = names.filter(n=>n!==recordToDelete);
        await safeSetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY], { names });

        // If current record was the deleted one => switch to default and load
        const currentDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const current = currentDoc.exists()? currentDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        if(current===recordToDelete) await mafia_loadRecord(MAFIA_DEFAULT_RECORD_NAME);

        await mafia_updateRecordSelector(current===recordToDelete?MAFIA_DEFAULT_RECORD_NAME:current);

        // also clear local cache if it contained the deleted data
        localStorage.removeItem('mafia_temp');
        showToast('✅ تم الحذف');
      }catch(e){ console.error('delete', e); showToast('❌ خطأ في الحذف'); }
    }

    // --------------------------- Input fields UI ---------------------------
    function createInputGroupElement(index, initialValue){
      const div = document.createElement('div'); div.className='input-group';
      div.innerHTML = `
        <button class="remove-field-btn control-btn" title="حذف الخانة">حذف</button>
        <div class="input-number">${index}.</div>
        <input type="text" id="mafiaTextInput${index}" value="${escapeHtml(initialValue)}" placeholder="أدخل النص...">
        <button class="copy-btn control-btn" title="نسخ">نسخ</button>
        <button class="paste-btn control-btn" title="لصق">لصق</button>
      `;
      return div;
    }

    window.mafia_addInputField = function(initialValue='', saveAfterAdd=true){
      mafia_inputCounter++;
      const container = el('mafiaInputFieldsContainer');
      const div = createInputGroupElement(mafia_inputCounter, initialValue);
      container.appendChild(div);

      // attach handlers
      const input = div.querySelector('input');
      const copyBtn = div.querySelector('.copy-btn');
      const pasteBtn = div.querySelector('.paste-btn');
      const removeBtn = div.querySelector('.remove-field-btn');

      input.addEventListener('input', debouncedSave);
      copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(input.value); copyBtn.textContent='✔'; setTimeout(()=>copyBtn.textContent='نسخ',1000); showToast('✅ تم النسخ'); }
        catch(e){ showToast('❌ فشل النسخ'); }
      });
      pasteBtn.addEventListener('click', async ()=>{
        try{ const t = await navigator.clipboard.readText(); input.value=t; debouncedSave(); showToast('✅ تم اللصق'); }
        catch(e){ showToast('❌ فشل اللصق') }
      });
      removeBtn.addEventListener('click', ()=>{
        // fade out then remove
        div.classList.add('fade-out');
        setTimeout(()=>{ div.remove(); mafia_updateInputNumbers(); debouncedSave(); }, 220);
      });

      if(saveAfterAdd) debouncedSave();
    }

    function mafia_updateInputNumbers(){ const groups = document.querySelectorAll('#mafiaInputFieldsContainer .input-group'); groups.forEach((g,i)=>{ const n = g.querySelector('.input-number'); if(n) n.textContent = (i+1)+'.'; }); mafia_inputCounter = groups.length; }

    window.mafia_clearCurrentDataAndStartNew = async function(){
      if(!confirm('مسح كل محتوى السجل الحالي؟')) return;
      el('mafiaInputFieldsContainer').querySelectorAll('.input-group').forEach(g=>g.classList.add('fade-out'));
      await wait(180);
      el('mafiaInputFieldsContainer').innerHTML=''; mafia_inputCounter=0; mafia_addInputField('', false);
      try{
        await safeSetDoc(["mafiaRecords", MAFIA_DEFAULT_RECORD_NAME], { data: [], lastUpdated: new Date() });
        await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: MAFIA_DEFAULT_RECORD_NAME });
        localStorage.removeItem('mafia_temp');
        await mafia_updateRecordSelector(MAFIA_DEFAULT_RECORD_NAME);
        showToast('✅ تم المسح');
      }catch(e){ console.error(e); showToast('❌ حدث خطأ'); }
    }

    // --------------------------- Saving (debounced) ---------------------------
    const debouncedSave = debounce(async ()=>{
      try{
        const inputs = document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]');
        const arr = Array.from(inputs).map(i=>i.value);
        // حفظ مؤقت في localStorage لأمان (cache)
        localStorage.setItem('mafia_temp', JSON.stringify(arr));
        // حفظ إلى السجل الحالي في Firebase (تأجيل لتقليل عمليات الكتابة)
        const currentDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const currentName = currentDoc.exists()? currentDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        await safeSetDoc(["mafiaRecords", currentName], { data: arr, lastUpdated: new Date() });
      }catch(e){ console.error('debouncedSave', e); }
    }, 900);

    // --------------------------- Links generation (utils) ---------------------------
    function createLinkRow(fullUrl){
      const p = document.createElement('p');
      p.style.display='flex'; p.style.gap='8px'; p.style.alignItems='center';
      const a = document.createElement('a'); a.href=fullUrl; a.target='_blank'; a.textContent=fullUrl;
      const copyBtn = document.createElement('button'); copyBtn.className='copy-link-btn'; copyBtn.textContent='نسخ';
      copyBtn.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(fullUrl); copyBtn.textContent='✔'; setTimeout(()=>copyBtn.textContent='نسخ',900); showToast('✅ تم النسخ'); }
        catch(e){ showToast('❌ فشل النسخ'); }
      });
      // delete generated link -> removes local cache & saved code entries that match this code
      const delBtn = document.createElement('button'); delBtn.className='copy-link-btn'; delBtn.textContent='حذف';
      delBtn.style.background = 'var(--danger)'; delBtn.style.marginLeft='6px';
      delBtn.addEventListener('click', ()=> deleteGeneratedProfileCode(fullUrl));
      p.appendChild(a); p.appendChild(copyBtn); p.appendChild(delBtn);
      return p;
    }

    async function deleteGeneratedProfileCode(fullUrl){
      // fullUrl like base + code -> try to extract code by matching bases
      try{
        // clear lastCode in localStorage if matches
        const last = localStorage.getItem('lastCode');
        if(last && fullUrl.endsWith(last)) localStorage.removeItem('lastCode');

        // also try to remove saved profile codes that have this code
        const code = profile_baseUrls.reduce((acc, base)=> fullUrl.startsWith(base) ? fullUrl.slice(base.length) : acc, null);
        if(code){
          // remove any saved profile code equal to code
          const saved = await profile_getSavedCodes();
          const filtered = saved.filter(s=>s.code !== code);
          if(filtered.length !== saved.length){
            await profile_saveCodes(filtered);
            await profile_renderSavedCodes();
          }
        }
        // refresh UI
        profile_generateProfileLinks();
        showToast('✅ تم الحذف من التخزين المحلي (إن وجد)');
      }catch(e){ console.error(e); showToast('❌ حدث خطأ أثناء الحذف'); }
    }

    // --------------------------- Profile links logic ---------------------------
    window.profile_generateProfileLinks = function(){
      const code = el('profileCode').value.trim(); const out = el('outputLinks'); out.innerHTML='';
      if(!code){ out.innerHTML = '<p class="small">⚠ الرجاء إدخال كود البروفايل.</p>'; return; }
      const frag = document.createDocumentFragment();
      profile_baseUrls.forEach(base=>{
        const full = base + code;
        frag.appendChild(createLinkRow(full));
      });
      out.appendChild(frag);
      // store last used
      localStorage.setItem('lastCode', code);
    }

    window.profile_openAllLinks = function(){ const links = el('outputLinks').querySelectorAll('a'); if(links.length===0){ showToast('لا توجد روابط'); return; } if(!confirm('فتح '+links.length+' رابط؟')) return; links.forEach(a=>window.open(a.href,'_blank')) }

    window.login_generateLoginLinks = function(){
      const code = el('loginCode').value.trim(); const out = el('outputLoginLinks'); out.innerHTML='';
      const frag = document.createDocumentFragment();
      login_baseUrls.forEach(base=>{
        const full = base + (code? '/'+code:'' );
        const p = document.createElement('p'); p.style.display='flex'; p.style.gap='8px'; p.style.alignItems='center';
        const a = document.createElement('a'); a.href=full; a.target='_blank'; a.textContent=full;
        const btn = document.createElement('button'); btn.className='copy-link-btn'; btn.textContent='نسخ';
        btn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(full); btn.textContent='✔'; setTimeout(()=>btn.textContent='نسخ',900); showToast('✅ تم النسخ'); }catch(e){ showToast('❌ فشل النسخ')} });
        p.appendChild(a); p.appendChild(btn); frag.appendChild(p);
      });
      out.appendChild(frag);
    }
    window.login_openAllLinks = function(){ const links = el('outputLoginLinks').querySelectorAll('a'); if(links.length===0){ showToast('لا توجد روابط'); return;} if(!confirm('فتح '+links.length+' رابط؟')) return; links.forEach(a=>window.open(a.href,'_blank')) }

    // --------------------------- Saved profile codes (Firestore) ---------------------------
    async function profile_getSavedCodes(){
      try{
        const docSnap = await safeGetDoc(["profileData", PROFILE_SAVED_CODES_KEY]);
        return docSnap.exists() && docSnap.data().codes ? docSnap.data().codes : [];
      }catch(e){ console.error('getSaved', e); return []; }
    }
    async function profile_saveCodes(codesArray){
      try{ await safeSetDoc(["profileData", PROFILE_SAVED_CODES_KEY], { codes: codesArray }); return true; }
      catch(e){ console.error('saveCodes', e); showToast('❌ فشل الحفظ'); return false; }
    }

    window.profile_saveProfileCode = async function(){
      const profileCode = el('profileCode').value.trim(); const codeName = el('codeName').value.trim();
      if(!profileCode){ showToast('⚠ ادخل كود'); return; } if(!codeName){ showToast('⚠ ادخل اسم'); return; }
      let saved = await profile_getSavedCodes();
      if(saved.some(s=>s.name===codeName)){ showToast('⚠ الاسم مستخدم'); return; }
      if(saved.some(s=>s.code===profileCode)){ showToast('⚠ الكود موجود'); return; }
      saved.push({ name: codeName, code: profileCode });
      if(await profile_saveCodes(saved)){ await profile_renderSavedCodes(); el('codeName').value=''; el('profileCode').value=''; showToast('✅ تم الحفظ'); }
    }

    window.profile_deleteProfileCode = async function(codeName){
      if(!confirm('حذف '+codeName+'؟')) return;
      let saved = await profile_getSavedCodes(); saved = saved.filter(s=>s.name!==codeName);
      if(await profile_saveCodes(saved)){ await profile_renderSavedCodes(); showToast('✅ تم الحذف'); }
    }

    window.profile_loadProfileCode = function(code){ el('profileCode').value = code; showToast('✅ تم تحميل الكود'); }

    async function profile_renderSavedCodes(filter = ''){
      const saved = await profile_getSavedCodes(); const out = el('savedCodesOutput');
      el('savedLoader').style.display = 'none';
      const list = saved.filter(s => !filter || s.name.includes(filter) || s.code.includes(filter));
      if(list.length===0){ out.innerHTML='<p>لا توجد أكواد محفوظة.</p>'; return; }
      const frag = document.createDocumentFragment();
      for(const item of list){
        const wrap = document.createElement('div'); wrap.className='saved-code-item';
        const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(item.name)}</strong> <div class="code-display">${escapeHtml(item.code)}</div>`;
        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
        const loadBtn = document.createElement('button'); loadBtn.className='btn ghost'; loadBtn.textContent='تحميل'; loadBtn.onclick = ()=>profile_loadProfileCode(item.code);
        const copyBtn = document.createElement('button'); copyBtn.className='btn'; copyBtn.textContent='نسخ'; copyBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(item.code); copyBtn.textContent='✔'; setTimeout(()=>copyBtn.textContent='نسخ',900); showToast('✅ تم النسخ'); }catch(e){ showToast('❌ فشل النسخ')} };
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='مسح'; delBtn.onclick = async ()=>{
          // animate remove
          wrap.classList.add('fade-out');
          await wait(220);
          profile_deleteProfileCode(item.name);
        };
        right.appendChild(loadBtn); right.appendChild(copyBtn); right.appendChild(delBtn);
        wrap.appendChild(left); wrap.appendChild(right); frag.appendChild(wrap);
      }
      out.innerHTML=''; out.appendChild(frag);
    }

    // --------------------------- Init on load ---------------------------
    document.addEventListener('DOMContentLoaded', async ()=>{
      // wire UI buttons
      el('addFieldBtn').addEventListener('click', ()=>mafia_addInputField('', true));
      el('clearAllBtn').addEventListener('click', ()=>mafia_clearCurrentDataAndStartNew());
      el('saveAsBtn').addEventListener('click', ()=>mafia_saveRecordAsNew());
      el('deleteRecordBtn').addEventListener('click', ()=>mafia_deleteSelectedRecord());
      el('genProfileBtn').addEventListener('click', ()=>profile_generateProfileLinks());
      el('openAllProfileBtn').addEventListener('click', ()=>profile_openAllLinks());
      el('genLoginBtn').addEventListener('click', ()=>login_generateLoginLinks());
      el('openAllLoginBtn').addEventListener('click', ()=>login_openAllLinks());
      el('saveCodeBtn').addEventListener('click', ()=>profile_saveProfileCode());
      el('loadDefaultBtn').addEventListener('click', ()=>mafia_loadRecord(MAFIA_DEFAULT_RECORD_NAME));
      el('savedSearch').addEventListener('input', debounce((e)=>profile_renderSavedCodes(e.target.value.trim()), 250));

      // initial load: always prefer Firebase as source of truth
      await mafia_updateRecordSelector();
      try{
        const currentRecordDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const currentRecordName = currentRecordDoc.exists() ? currentRecordDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        await mafia_loadRecord(currentRecordName);
      }catch(e){
        // fallback to local temp if Firestore unreachable
        const tmp = localStorage.getItem('mafia_temp');
        if(tmp){ try{ const arr = JSON.parse(tmp); if(Array.isArray(arr) && arr.length>0){ document.getElementById('mafiaInputFieldsContainer').innerHTML=''; mafia_inputCounter=0; arr.forEach(v=>mafia_addInputField(v,false)); mafia_updateInputNumbers(); showToast('⚠ تعملت من الكاش'); } }catch(err){} }
      }

      // ensure at least one field
      if(document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]').length===0) mafia_addInputField('', false);

      // render saved codes
      el('savedLoader').style.display = 'inline-block';
      await profile_renderSavedCodes();
    });

    // expose some functions to global scope for HTML onclicks (if needed)
    window.mafia_updateRecordSelector = mafia_updateRecordSelector;
    window.mafia_loadRecord = mafia_loadRecord;
    window.mafia_saveRecord = mafia_saveRecord;
    window.mafia_deleteSelectedRecord = mafia_deleteSelectedRecord;
    window.mafia_loadSelectedRecord = mafia_loadSelectedRecord;

  </script>
</body>
</html>
