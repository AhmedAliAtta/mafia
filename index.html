<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>أدوات إدخال النصوص والبروفايلات — المحسّن</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1720; --card:#0f1726; --muted:#97a0ad; --accent:#00e6ac; --danger:#ff5c5c; --glass: rgba(255,255,255,0.03);
      --transition: 180ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Playpen Sans Arabic',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; 
      background:linear-gradient(180deg,#091018 0%, #071021 100%); color:#e6eef6; direction:rtl; 
      -webkit-font-smoothing:antialiased; padding:18px;
    }
    .app{max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 420px; gap:20px; align-items:start}
    header{grid-column:1/ -1; display:flex; justify-content:space-between; align-items:center; gap:12px}
    h1{margin:0; font-size:20px; color:var(--accent)}
    .subtitle{color:var(--muted); font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 6px 24px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}

    /* Left column (main tools) */
    .main .section{margin-bottom:18px}
    label{display:block; font-weight:700; margin-bottom:6px}
    input[type=text], select{width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
    .button-row{display:flex; gap:8px; margin-top:10px}
    .btn{background:var(--accent); color:#001; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700}
    .btn.ghost{background:transparent; color:var(--accent); border:1px solid rgba(255,255,255,0.04)}
    .small{font-size:13px; color:var(--muted)}

    /* Input list */
    #mafiaInputFieldsContainer{display:flex; flex-direction:column; gap:10px}
    .input-group{display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:8px; transition: all var(--transition) ease}
    .input-group.fade-out{opacity:0; transform:translateY(-6px); height:0; padding:0 8px; margin:0}
    .input-number{min-width:30px; text-align:center; color:var(--muted)}
    .input-group input{flex:1; background:transparent; color:inherit; border:none; outline:none}
    .control-btn{padding:8px 10px; border-radius:8px; border:none; cursor:pointer}
    .copy-btn{background:#2ecc71;color:#012;border-radius:8px;padding:8px 10px}
    .paste-btn{background:#3498db;color:white}
    .remove-field-btn{background:var(--danger); color:white}

    /* Right column */
    .side .section + .section{margin-top:14px}
    .links-output p{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:6px 0}
    .links-output a{color:var(--accent); text-decoration:none; max-width:72%; overflow-wrap:anywhere}
    .links-output .copy-link-btn{background:#2b7a5f; border-radius:8px; padding:6px 10px; color:white; border:none; cursor:pointer}
    .links-output .copy-link-btn:active{transform:scale(.98)}

    /* saved list */
    .saved-codes-output .saved-code-item{display:flex; justify-content:space-between; gap:8px; padding:10px; border-radius:8px; align-items:center; background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008)); transition: all var(--transition)}
    .saved-codes-output .saved-code-item.fade-out{opacity:0; transform:translateX(8px); height:0; padding:0; margin:0}
    .saved-codes-output .code-display{font-family:monospace; color:var(--muted); font-size:13px}

    footer{grid-column:1/-1; margin-top:18px; color:var(--muted); font-size:13px; text-align:center}

    /* search */
    .search-row{display:flex; gap:8px; align-items:center; margin-top:8px}
    .search-input{flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}

    /* loader */
    .loader{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.06);border-top-color:var(--accent);border-radius:50%;animation:spin 800ms linear infinite;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* toast */
    .toast{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.7);color:#fff;padding:10px 14px;border-radius:8px;z-index:2000;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}

    @media (max-width:980px){.app{grid-template-columns:1fr} .side{order:-1}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>مولد الروابط الذكي — لوحة السيطرة</h1>
        <div class="subtitle">نسخة محسّنة — كل المزايا محفوظة + أداء وواجهة أفضل</div>
      </div>
      <div class="small">حفظ تلقائي مؤقت • يدعم Firebase • اختصارات للنسخ</div>
    </header>

    <main class="main card">
      <section class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <strong>أداة إدخال النصوص</strong>
          <div class="small">أضف أكثر من خانة — احفظ السجلات في Firebase</div>
        </div>

        <div id="mafiaInputFieldsContainer"></div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn" id="addFieldBtn"><i class="fas fa-plus-circle"></i>&nbsp; إضافة خانة</button>
          <button class="btn ghost" id="clearAllBtn"><i class="fas fa-trash"></i>&nbsp; مسح الكل</button>
        </div>
      </section>

      <section class="section">
        <strong>السجلات (Records)</strong>
        <div style="display:flex;gap:10px;margin-top:8px;align-items:center">
          <select id="mafiaRecordSelector" style="flex:1"></select>
          <button class="btn" id="saveAsBtn"><i class="fas fa-save"></i>&nbsp; حفظ باسم</button>
          <button class="btn ghost" id="deleteRecordBtn"><i class="fas fa-trash-alt"></i>&nbsp; حذف</button>
        </div>
        <div class="small" style="margin-top:8px">السجل الحالي محفوظ آلياً مع تأخير (debounced) لتقليل عمليات الكتابة على Firebase.</div>
      </section>

      <section class="section">
        <strong>مولّد روابط البروفايلات</strong>
        <div class="small">أدخل كود بروفايل (Base64) واضغط توليد</div>
        <label for="profileCode">كود البروفايل</label>
        <input type="text" id="profileCode" placeholder="مثال: NDIyNDk2MjQ5Mw==">
        <div class="button-row">
          <button class="btn" id="genProfileBtn">توليد الروابط</button>
          <button class="btn ghost" id="openAllProfileBtn">فتح كل الروابط</button>
        </div>
        <div id="outputLinks" class="links-output" style="margin-top:10px">لا توجد روابط.</div>
      </section>

      <section class="section">
        <strong>مولّد روابط تسجيل الدخول</strong>
        <label for="loginCode">كود (اختياري)</label>
        <input type="text" id="loginCode" placeholder="أي كود أو اتركه فارغًا">
        <div class="button-row">
          <button class="btn" id="genLoginBtn">توليد روابط الدخول</button>
          <button class="btn ghost" id="openAllLoginBtn">فتح</button>
        </div>
        <div id="outputLoginLinks" class="links-output" style="margin-top:10px">لا توجد روابط.</div>
      </section>
    </main>

    <aside class="side card">
      <section class="section">
        <strong>إدارة أكواد البروفايلات المحفوظة</strong>
        <div class="small">احفظ كود باسم — يعرض الأكواد مع أزرار تحميل/نسخ/حذف</div>

        <div class="search-row">
          <input type="text" id="savedSearch" class="search-input" placeholder="ابحث في الأكواد المحفوظة...">
          <div id="savedLoader" style="display:none" class="loader" title="جاري التحميل"></div>
        </div>

        <label for="codeName" style="margin-top:8px">اسم الكود</label>
        <input type="text" id="codeName" placeholder="مثال: بروفايل صديق">
        <div class="button-row" style="margin-top:8px">
          <button class="btn" id="saveCodeBtn">حفظ الكود</button>
        </div>
        <div id="savedCodesOutput" class="saved-codes-output" style="margin-top:12px">لا توجد أكواد محفوظة.</div>
      </section>

      <section class="section" style="margin-top:14px">
        <strong>السجل الافتراضي</strong>
        <div class="small">استخدم السجل الافتراضي للمهام السريعة</div>
        <div style="margin-top:10px"><button class="btn ghost" id="loadDefaultBtn">تحميل افتراضي</button></div>
      </section>
    </aside>

    <footer>🌟 تم تحسين الأداء: حفظ آلي مؤجل، تحديث DOM بكفاءة، ومزامنة كاملة مع Firebase.</footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script type="module">
    // --------------------------- Firebase init ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4_IUaC1uiqq05TKpL348kXt1aNJf1jzM",
      authDomain: "mafia-3l-entag.firebaseapp.com",
      projectId: "mafia-3l-entag",
      storageBucket: "mafia-3l-entag.firebasestorage.app",
      messagingSenderId: "995219729881",
      appId: "1:995219729881:web:5d128bce8987d812adfdc8",
      measurementId: "G-Z7ZMFV8VV8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --------------------------- State & constants ---------------------------
    const state = {
      mafiaInputCounter: 0,
      currentRecordName: 'السجل الافتراضي',
    };

    const MAFIA_RECORD_NAMES_KEY = 'mafiaRecordNames';
    const MAFIA_CURRENT_RECORD_KEY = 'mafiaCurrentRecord';
    const MAFIA_DEFAULT_RECORD_NAME = 'السجل الافتراضي';

    const profile_baseUrls = [
      "https://mixu.chat/profile/",
      "https://1v1chat.me/profile/",
      "https://livcam.me/profile/",
      "https://tinchat.me/profile/",
      "https://livuapp.com/profile/"
    ];

    const login_baseUrls = [
      "https://mixu.chat/login",
      "https://1v1chat.me/login",
      "https://livcam.me/login",
      "https://tinchat.me/login",
      "https://livuapp.com/login"
    ];

    const PROFILE_SAVED_CODES_KEY = 'savedProfileCodesList';

    // --------------------------- Helpers ---------------------------
    const el = (id) => document.getElementById(id);
    const showToast = (msg) => { const t = el('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1800); };
    const debounce = (func, wait) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func(...a), wait); }; };
    const wait = (ms) => new Promise(r => setTimeout(r, ms));
    const escapeHtml = (s) => s ? String(s).replace(/[&<>"]+/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;" }[c] || c)) : '';
    const safeGetDoc = async (path) => {
      try { return await getDoc(doc(db, ...path)); } catch (e) { console.error('safeGetDoc', e); throw e; }
    };
    const safeSetDoc = async (path, data) => {
      try { await setDoc(doc(db, ...path), data); } catch (e) { console.error('safeSetDoc', e); throw e; }
    };
    const safeDeleteDoc = async (path) => {
      try { await deleteDoc(doc(db, ...path)); } catch (e) { console.error('safeDeleteDoc', e); throw e; }
    };

    // Helper for creating and styling buttons
    const createButton = (text, className, handler, title = '') => {
      const btn = document.createElement('button');
      btn.className = className;
      btn.textContent = text;
      btn.title = title;
      btn.addEventListener('click', handler);
      return btn;
    };

    // Unified copy function
    const copyToClipboard = async (text, btn) => {
      try {
        await navigator.clipboard.writeText(text);
        btn.textContent = '✔';
        setTimeout(() => btn.textContent = 'نسخ', 900);
        showToast('✅ تم النسخ');
      } catch (e) {
        showToast('❌ فشل النسخ');
      }
    };

    // --------------------------- Records CRUD ---------------------------
    const saveRecord = async (recordName) => {
      const inputElements = document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]');
      const dataToSave = Array.from(inputElements).map(i => i.value);
      try {
        const isDefault = recordName === MAFIA_DEFAULT_RECORD_NAME;
        const docPath = isDefault ? ["mafiaDefaultRecord", "default"] : ["mafiaRecords", recordName];

        await safeSetDoc(docPath, { data: dataToSave, lastUpdated: new Date() });

        if (!isDefault) {
          let recordNames = await getRecordNamesFromFirebase();
          if (!recordNames.includes(recordName)) {
            recordNames.push(recordName);
            await safeSetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY], { names: recordNames });
          }
          await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: recordName });
          updateRecordSelector(recordName);
        }

        state.currentRecordName = recordName;
        localStorage.removeItem('mafia_temp_' + recordName);

        return true;
      } catch (e) {
        console.error('saveRecord', e);
        showToast('❌ فشل حفظ السجل');
        return false;
      }
    };

    const loadRecord = async (recordName) => {
      const container = el('mafiaInputFieldsContainer');
      container.innerHTML = '';
      try {
        const isDefault = recordName === MAFIA_DEFAULT_RECORD_NAME;
        const docPath = isDefault ? ["mafiaDefaultRecord", "default"] : ["mafiaRecords", recordName];

        const docSnap = await safeGetDoc(docPath);
        if (docSnap.exists()) {
          const dataArray = docSnap.data().data || [];
          state.mafiaInputCounter = 0;
          for (const v of dataArray) addInputField(v, false);
        } else {
          state.mafiaInputCounter = 0;
          addInputField('', false);
        }
        updateInputNumbers();

        if (!isDefault) {
          await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: recordName });
          updateRecordSelector(recordName);
        }

        state.currentRecordName = recordName;
        localStorage.removeItem('mafia_temp_' + recordName);

        return true;
      } catch (e) {
        console.error('loadRecord', e);
        showToast('❌ فشل تحميل السجل — سيتم استعادة الكاش إن وُجد');
        // Fallback to local cache
        try {
          const tmp = localStorage.getItem('mafia_temp_' + recordName);
          if (tmp) {
            const arr = JSON.parse(tmp);
            if (Array.isArray(arr) && arr.length > 0) {
              container.innerHTML = '';
              state.mafiaInputCounter = 0;
              arr.forEach(v => addInputField(v, false));
              updateInputNumbers();
              showToast('⚠ تم استعادة البيانات من الكاش المحلي');
            }
          }
        } catch (er) {
          console.error('restore cache', er);
        }
        return false;
      }
    };

    const getRecordNamesFromFirebase = async () => {
      try {
        const docSnap = await safeGetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY]);
        let namesArray = docSnap.exists() && docSnap.data().names ? docSnap.data().names : [];
        if (!namesArray.includes(MAFIA_DEFAULT_RECORD_NAME)) namesArray.unshift(MAFIA_DEFAULT_RECORD_NAME);
        else { namesArray = namesArray.filter(n => n !== MAFIA_DEFAULT_RECORD_NAME); namesArray.unshift(MAFIA_DEFAULT_RECORD_NAME); }
        return namesArray;
      } catch (e) { console.error('getRecordNames', e); return [MAFIA_DEFAULT_RECORD_NAME]; }
    };

    const updateRecordSelector = async (selectedName = '') => {
      const selector = el('mafiaRecordSelector');
      selector.innerHTML = '';
      const recordNames = await getRecordNamesFromFirebase();
      for (const name of recordNames) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === selectedName) opt.selected = true;
        selector.appendChild(opt);
      }
      const deleteBtn = el('deleteRecordBtn');
      if (deleteBtn) deleteBtn.disabled = (recordNames.length === 1 && recordNames[0] === MAFIA_DEFAULT_RECORD_NAME);
    };

    const saveRecordAsNew = async () => {
      let recordName = prompt('ادخل اسم للسجل الجديد:');
      if (recordName && recordName.trim() !== '') {
        recordName = recordName.trim();
        const recordNames = await getRecordNamesFromFirebase();
        if (recordNames.includes(recordName)) { if (!confirm(`السجل "${recordName}" موجود، استبداله؟`)) return; }
        const ok = await saveRecord(recordName);
        if (ok) {
          await safeSetDoc(["mafiaRecords", MAFIA_DEFAULT_RECORD_NAME], { data: [], lastUpdated: new Date() });
          await loadRecord(recordName);
          showToast('✅ تم الحفظ');
        }
      } else if (recordName !== null) showToast('⚠ يجب ادخال اسم');
    };

    const loadSelectedRecord = async () => {
      const sel = el('mafiaRecordSelector');
      if (sel.value) await loadRecord(sel.value);
    };

    const deleteSelectedRecord = async () => {
      const sel = el('mafiaRecordSelector');
      const recordToDelete = sel.value;
      if (recordToDelete === MAFIA_DEFAULT_RECORD_NAME) {
        showToast('⚠ لا يمكنك حذف السجل الافتراضي');
        return;
      }
      if (!confirm('تأكيد حذف ' + recordToDelete + '؟')) return;
      try {
        await safeDeleteDoc(["mafiaRecords", recordToDelete]);
        let names = await getRecordNamesFromFirebase();
        names = names.filter(n => n !== recordToDelete);
        await safeSetDoc(["mafiaMetadata", MAFIA_RECORD_NAMES_KEY], { names });
        const currentDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const current = currentDoc.exists() ? currentDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        if (current === recordToDelete) await loadRecord(MAFIA_DEFAULT_RECORD_NAME);
        await updateRecordSelector(current === recordToDelete ? MAFIA_DEFAULT_RECORD_NAME : current);
        localStorage.removeItem('mafia_temp');
        localStorage.removeItem('mafia_temp_' + recordToDelete);
        showToast('✅ تم الحذف');
      } catch (e) {
        console.error('delete', e);
        showToast('❌ خطأ في الحذف');
      }
    };

    // --------------------------- Input fields UI ---------------------------
    const createInputGroupElement = (index, initialValue) => {
      const div = document.createElement('div');
      div.className = 'input-group';

      const removeBtn = createButton('حذف', 'remove-field-btn control-btn', () => {
        div.classList.add('fade-out');
        setTimeout(() => {
          div.remove();
          updateInputNumbers();
          debouncedSave();
        }, 220);
      }, 'حذف الخانة');

      const numberDiv = document.createElement('div');
      numberDiv.className = 'input-number';
      numberDiv.textContent = index + '.';

      const input = document.createElement('input');
      input.type = 'text';
      input.id = 'mafiaTextInput' + index;
      input.value = initialValue || '';
      input.placeholder = 'أدخل النص...';
      input.addEventListener('input', debouncedSave);

      const copyBtn = createButton('نسخ', 'copy-btn control-btn', () => copyToClipboard(input.value, copyBtn), 'نسخ');
      const pasteBtn = createButton('لصق', 'paste-btn control-btn', async () => {
        try {
          const t = await navigator.clipboard.readText();
          input.value = t;
          debouncedSave();
          showToast('✅ تم اللصق');
        } catch (e) {
          showToast('❌ فشل اللصق');
        }
      }, 'لصق');

      div.append(removeBtn, numberDiv, input, copyBtn, pasteBtn);
      return div;
    };

    const addInputField = (initialValue = '', saveAfterAdd = true) => {
      state.mafiaInputCounter++;
      const container = el('mafiaInputFieldsContainer');
      const div = createInputGroupElement(state.mafiaInputCounter, initialValue);
      container.appendChild(div);
      if (saveAfterAdd) debouncedSave();
    };

    const updateInputNumbers = () => {
      const groups = document.querySelectorAll('#mafiaInputFieldsContainer .input-group');
      groups.forEach((g, i) => {
        const n = g.querySelector('.input-number');
        if (n) n.textContent = (i + 1) + '.';
      });
      state.mafiaInputCounter = groups.length;
    };

    const clearCurrentDataAndStartNew = async () => {
      if (!confirm('مسح كل محتوى السجل الحالي؟')) return;
      el('mafiaInputFieldsContainer').querySelectorAll('.input-group').forEach(g => g.classList.add('fade-out'));
      await wait(180);
      el('mafiaInputFieldsContainer').innerHTML = '';
      state.mafiaInputCounter = 0;
      addInputField('', false);
      try {
        await safeSetDoc(["mafiaRecords", MAFIA_DEFAULT_RECORD_NAME], { data: [], lastUpdated: new Date() });
        await safeSetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY], { current: MAFIA_DEFAULT_RECORD_NAME });
        localStorage.removeItem('mafia_temp');
        localStorage.removeItem('mafia_temp_' + MAFIA_DEFAULT_RECORD_NAME);
        await updateRecordSelector(MAFIA_DEFAULT_RECORD_NAME);
        showToast('✅ تم المسح');
      } catch (e) {
        console.error(e);
        showToast('❌ حدث خطأ');
      }
    };

    // --------------------------- Saving (debounced) ---------------------------
    const debouncedSave = debounce(async () => {
      try {
        const inputs = document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]');
        const arr = Array.from(inputs).map(i => i.value);
        const key = 'mafia_temp_' + state.currentRecordName;
        localStorage.setItem(key, JSON.stringify(arr));
        const saveTo = state.currentRecordName;
        await safeSetDoc(["mafiaRecords", saveTo], { data: arr, lastUpdated: new Date() });
      } catch (e) {
        console.error('debouncedSave', e);
      }
    }, 900);

    // --------------------------- Links generation (utils) ---------------------------
    const createLinkRow = (fullUrl, showDelete = false) => {
      const p = document.createElement('p');
      p.style.display = 'flex';
      p.style.gap = '8px';
      p.style.alignItems = 'center';

      const a = document.createElement('a');
      a.href = fullUrl;
      a.target = '_blank';
      a.textContent = fullUrl;
      
      const copyBtn = createButton('نسخ', 'copy-link-btn', () => copyToClipboard(fullUrl, copyBtn));
      
      p.append(a, copyBtn);
      
      if (showDelete) {
        const delBtn = createButton('حذف', 'copy-link-btn', () => deleteGeneratedProfileCode(fullUrl));
        delBtn.style.background = 'var(--danger)';
        delBtn.style.marginLeft = '6px';
        p.appendChild(delBtn);
      }

      return p;
    };

    const deleteGeneratedProfileCode = async (fullUrl) => {
      try {
        const last = localStorage.getItem('lastCode');
        if (last && fullUrl.endsWith(last)) localStorage.removeItem('lastCode');
        const code = profile_baseUrls.reduce((acc, base) => fullUrl.startsWith(base) ? fullUrl.slice(base.length) : acc, null);
        if (code) {
          const saved = await getSavedCodes();
          const filtered = saved.filter(s => s.code !== code);
          if (filtered.length !== saved.length) {
            await saveCodes(filtered);
            await renderSavedCodes();
          }
        }
        generateProfileLinks();
        showToast('✅ تم الحذف من التخزين المحلي (إن وجد)');
      } catch (e) {
        console.error(e);
        showToast('❌ حدث خطأ أثناء الحذف');
      }
    };

    const generateProfileLinks = () => {
      const code = el('profileCode').value.trim();
      const out = el('outputLinks');
      out.innerHTML = '';
      if (!code) {
        out.innerHTML = '<p class="small">⚠ الرجاء إدخال كود البروفايل.</p>';
        return;
      }
      const frag = document.createDocumentFragment();
      profile_baseUrls.forEach(base => {
        const full = base + code;
        frag.appendChild(createLinkRow(full, true));
      });
      out.appendChild(frag);
      localStorage.setItem('lastCode', code);
    };

    const openAllProfileLinks = () => {
      const links = el('outputLinks').querySelectorAll('a');
      if (links.length === 0) { showToast('لا توجد روابط'); return; }
      if (!confirm('فتح ' + links.length + ' رابط؟')) return;
      links.forEach(a => window.open(a.href, '_blank'));
    };

    const generateLoginLinks = () => {
      const code = el('loginCode').value.trim();
      const out = el('outputLoginLinks');
      out.innerHTML = '';
      const frag = document.createDocumentFragment();
      login_baseUrls.forEach(base => {
        const full = base + (code ? '/' + code : '');
        frag.appendChild(createLinkRow(full));
      });
      out.appendChild(frag);
    };

    const openAllLoginLinks = () => {
      const links = el('outputLoginLinks').querySelectorAll('a');
      if (links.length === 0) { showToast('لا توجد روابط'); return; }
      if (!confirm('فتح ' + links.length + ' رابط؟')) return;
      links.forEach(a => window.open(a.href, '_blank'));
    };

    // --------------------------- Saved profile codes (Firestore) ---------------------------
    const getSavedCodes = async () => {
      try {
        const docSnap = await safeGetDoc(["profileData", PROFILE_SAVED_CODES_KEY]);
        return docSnap.exists() && docSnap.data().codes ? docSnap.data().codes : [];
      } catch (e) {
        console.error('getSaved', e);
        return [];
      }
    };

    const saveCodes = async (codesArray) => {
      try {
        await safeSetDoc(["profileData", PROFILE_SAVED_CODES_KEY], { codes: codesArray });
        return true;
      } catch (e) {
        console.error('saveCodes', e);
        showToast('❌ فشل الحفظ');
        return false;
      }
    };

    const saveProfileCode = async () => {
      const profileCode = el('profileCode').value.trim();
      const codeName = el('codeName').value.trim();
      if (!profileCode) { showToast('⚠ ادخل كود'); return; }
      if (!codeName) { showToast('⚠ ادخل اسم'); return; }
      let saved = await getSavedCodes();
      if (saved.some(s => s.name === codeName)) { showToast('⚠ الاسم مستخدم'); return; }
      if (saved.some(s => s.code === profileCode)) { showToast('⚠ الكود موجود'); return; }
      saved.push({ name: codeName, code: profileCode });
      if (await saveCodes(saved)) {
        await renderSavedCodes();
        el('codeName').value = '';
        el('profileCode').value = '';
        showToast('✅ تم الحفظ');
      }
    };

    const deleteProfileCode = async (codeName) => {
      if (!confirm('حذف ' + codeName + '؟')) return;
      let saved = await getSavedCodes();
      saved = saved.filter(s => s.name !== codeName);
      if (await saveCodes(saved)) {
        await renderSavedCodes();
        showToast('✅ تم الحذف');
      }
    };

    const loadProfileCode = (code) => {
      el('profileCode').value = code;
      showToast('✅ تم تحميل الكود');
    };

    const renderSavedCodes = async (filter = '') => {
      const saved = await getSavedCodes();
      const out = el('savedCodesOutput');
      el('savedLoader').style.display = 'none';
      const list = saved.filter(s => !filter || s.name.includes(filter) || s.code.includes(filter));
      
      out.innerHTML = ''; // Clear previous content

      if (list.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'لا توجد أكواد محفوظة.';
        out.appendChild(p);
        return;
      }

      const frag = document.createDocumentFragment();
      for (const item of list) {
        const wrap = document.createElement('div');
        wrap.className = 'saved-code-item';

        const left = document.createElement('div');
        const nameStrong = document.createElement('strong');
        nameStrong.textContent = escapeHtml(item.name);
        const codeDiv = document.createElement('div');
        codeDiv.className = 'code-display';
        codeDiv.textContent = escapeHtml(item.code);
        left.append(nameStrong, codeDiv);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '6px';
        
        const loadBtn = createButton('تحميل', 'btn ghost', () => loadProfileCode(item.code));
        const copyBtn = createButton('نسخ', 'btn', () => copyToClipboard(item.code, copyBtn));
        const delBtn = createButton('مسح', 'btn ghost', async () => {
          wrap.classList.add('fade-out');
          await wait(220);
          deleteProfileCode(item.name);
        });
        
        right.append(loadBtn, copyBtn, delBtn);
        wrap.append(left, right);
        frag.appendChild(wrap);
      }
      out.appendChild(frag);
    };

    // --------------------------- Init on load ---------------------------
    document.addEventListener('DOMContentLoaded', async () => {
      // Wire UI buttons
      el('addFieldBtn').addEventListener('click', () => addInputField('', true));
      el('clearAllBtn').addEventListener('click', clearCurrentDataAndStartNew);
      el('saveAsBtn').addEventListener('click', saveRecordAsNew);
      el('deleteRecordBtn').addEventListener('click', deleteSelectedRecord);
      el('genProfileBtn').addEventListener('click', generateProfileLinks);
      el('openAllProfileBtn').addEventListener('click', openAllProfileLinks);
      el('genLoginBtn').addEventListener('click', generateLoginLinks);
      el('openAllLoginBtn').addEventListener('click', openAllLoginLinks);
      el('saveCodeBtn').addEventListener('click', saveProfileCode);
      el('loadDefaultBtn').addEventListener('click', () => loadRecord(MAFIA_DEFAULT_RECORD_NAME));
      el('mafiaRecordSelector').addEventListener('change', loadSelectedRecord);
      el('savedSearch').addEventListener('input', debounce((e) => renderSavedCodes(e.target.value.trim()), 250));

      // Initial load: always prefer Firebase as source of truth
      await updateRecordSelector();
      try {
        const currentRecordDoc = await safeGetDoc(["mafiaMetadata", MAFIA_CURRENT_RECORD_KEY]);
        const currentRecordName = currentRecordDoc.exists() ? currentRecordDoc.data().current : MAFIA_DEFAULT_RECORD_NAME;
        state.currentRecordName = currentRecordName;
        await loadRecord(currentRecordName);
      } catch (e) {
        // Fallback to local temp if Firestore unreachable
        const tmp = localStorage.getItem('mafia_temp');
        if (tmp) {
          try {
            const arr = JSON.parse(tmp);
            if (Array.isArray(arr) && arr.length > 0) {
              document.getElementById('mafiaInputFieldsContainer').innerHTML = '';
              state.mafiaInputCounter = 0;
              arr.forEach(v => addInputField(v, false));
              updateInputNumbers();
              showToast('⚠ تعملت من الكاش');
            }
          } catch (err) {}
        }
      }

      // Ensure at least one field
      if (document.querySelectorAll('#mafiaInputFieldsContainer input[type="text"]').length === 0) {
        addInputField('', false);
      }

      // Render saved codes
      el('savedLoader').style.display = 'inline-block';
      await renderSavedCodes();
    });
  </script>
</body>
</html>
